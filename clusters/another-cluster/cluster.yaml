apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: ${CLUSTER_NAME}
  namespace: default
spec:
  clusterNetwork:
    services:
      cidrBlocks:
      - 10.12.0.0/16
  controlPlaneRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
    kind: AzureManagedControlPlane
    name: ${CLUSTER_NAME}
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
    kind: AzureManagedCluster
    name: ${CLUSTER_NAME}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AzureManagedControlPlane
metadata:
  name: ${CLUSTER_NAME}
  namespace: default
spec:
  additionalTags:
    jobName: ${JOB_NAME:=""}
    creationTimestamp: ${TIMESTAMP:=""}
    buildProvenance: ${BUILD_PROVENANCE:=""}
  identityRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
    kind: AzureClusterIdentity
    name: ${CLUSTER_IDENTITY_NAME}
    namespace: ${CLUSTER_IDENTITY_NAMESPACE}
  location: eastus
  resourceGroupName: ${CLUSTER_NAME}
  sshPublicKey: ${AZURE_SSH_PUBLIC_KEY_B64:=""}
  subscriptionID: ${AZURE_SUBSCRIPTION_ID}
  version: ${KUBERNETES_VERSION}
  networkPolicy: azure
  networkPlugin: azure
  # sku: Paid
  loadBalancerProfile:
    managedOutboundIPs: 6
    idleTimeoutInMinutes: 9
---
# apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
# kind: AzureManagedCluster
# metadata:
#   name: ${CLUSTER_NAME}
#   namespace: default
# ---
# apiVersion: cluster.x-k8s.io/v1beta1
# kind: MachinePool
# metadata:
#   name: agentpool0
#   namespace: default
# spec:
#   clusterName: ${CLUSTER_NAME}
#   replicas: 1
#   template:
#     metadata: {}
#     spec:
#       bootstrap:
#         dataSecretName: ""
#       clusterName: ${CLUSTER_NAME}
#       infrastructureRef:
#         apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
#         kind: AzureManagedMachinePool
#         name: agentpool0
#       version: ${KUBERNETES_VERSION}
# ---
# apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
# kind: AzureManagedMachinePool
# metadata:
#   name: agentpool0
#   namespace: default
# spec:
#   maxPods: 40
#   mode: System
#   osDiskSizeGB: 60
#   osDiskType: Managed
#   sku: Standard_D16_v4
# ---
# apiVersion: cluster.x-k8s.io/v1beta1
# kind: MachinePool
# metadata:
#   name: agentpool1
#   namespace: default
# spec:
#   clusterName: ${CLUSTER_NAME}
#   replicas: 1
#   template:
#     metadata: {}
#     spec:
#       bootstrap:
#         dataSecretName: ""
#       clusterName: ${CLUSTER_NAME}
#       infrastructureRef:
#         apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
#         kind: AzureManagedMachinePool
#         name: agentpool1
#       version: ${KUBERNETES_VERSION}
# ---
# apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
# kind: AzureManagedMachinePool
# metadata:
#   name: agentpool1
#   namespace: default
# spec:
#   maxPods: 250
#   mode: User
#   osDiskSizeGB: 512
#   osDiskType: Ephemeral
#   sku: Standard_F64s_v2
#   scaling:
#     minSize: 2
#     maxSize: 24
# ---
# apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
# kind: AzureClusterIdentity
# metadata:
#   name: ${CLUSTER_IDENTITY_NAME}
#   namespace: default
# spec:
#   allowedNamespaces: {}
#   clientID: ${AZURE_CLIENT_ID}
#   clientSecret:
#     name: ${AZURE_CLUSTER_IDENTITY_SECRET_NAME}
#     namespace: ${AZURE_CLUSTER_IDENTITY_SECRET_NAMESPACE}
#   tenantID: ${AZURE_TENANT_ID}
#   type: ServicePrincipal
